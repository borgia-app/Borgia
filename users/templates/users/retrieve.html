{% extends 'base_sober.html' %}
{% load finances_extra %}

{% block content %}
<div class="panel panel-default">
  <div class="panel-heading">
    Détails de l'utilisateur
      <div class="btn-group" role="group" aria-label="change user">
        {% if group|has_group_perm:"change_user" %}
          <a class="btn btn-primary" href="{% url 'url_user_update' group_name=group_name pk=object.pk %}">Modifier les informations</a>
        {% endif %}
        {% if group|has_group_perm:"delete_user" or object.pk == request.user.pk %}
          {% if object.pk == request.user.pk %}
            <a class="btn btn-primary" href="{% url 'url_self_deactivate' group_name=group_name pk=object.pk %}">
                {% if object.is_active == True %}
                    Désactiver mon compte
                {% else %}
                    Activer mon compte
                {% endif %}
            </a>
          {% else %}
            <a class="btn btn-primary" href="{% url 'url_user_deactivate' group_name=group_name pk=object.pk %}">
                {% if object.is_active == True %}
                    Désactiver le compte
                {% else %}
                    Activer le compte
                {% endif %}
            </a>
          {% endif %}
        {% endif %}
        {% if group|has_group_perm:"add_exceptionnal_movement" %}
          <a class="btn btn-primary" href="{% url 'url_user_exceptionnalmovement_create' group_name=group_name user_pk=object.pk %}">Mouvement exceptionnel</a>
        {% endif %}
        {% if group|has_group_perm:"supply_money_user" %}
          <a class="btn btn-primary" href="{% url 'url_user_supplymoney' group_name=group_name user_pk=object.pk %}">Ajout d'argent</a>
        {% endif %}
      </div>
  </div>
  <div class="panel-body">
    <div class="row">
        {% include "users/retrieve_module.html" %}
    </div>
  </div>
</div>
{% if group|has_group_perm:"retrieve_more_user_info" %}
<div class="panel panel-default">
  <div class="panel-heading">
    Dernières transactions
  </div>
  <table class="table table-default table-striped table-hover">
    <thead>
      <tr>
        <th>Date</th>
        <th>Libellé</th>
        <th>Montant</th>
        {% if group|has_group_perm:"retrieve_sale" %}
          <th>Détail</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for transaction in object.list_transaction|slice:":50" %}
      {% price_for sale=transaction user=object as price_for %}
      <tr class="
      {% if transaction|get_transaction_model == 'Sale' %}
        danger
      {% elif transaction|get_transaction_model == 'ExceptionnalMovement' %}
        {% if transaction.is_credit %}
          success
        {% else %}
          danger
        {% endif %}
      {% elif transaction|get_transaction_model == 'Transfert' %}
        {% if transaction.recipient == object %}
          success
        {% else %}
          danger
        {% endif %}
      {% elif transaction|get_transaction_model == 'SharedEvent' %}
        danger
      {% else %}
        success
      {% endif %}
      ">
        <td>{{ transaction.datetime }}</td>
        <td>
          {{ transaction.wording }}
        </td>
        <td>
          {% if transaction|get_transaction_model == 'Sale' %}
            -{{ transaction.amount }}€
          {% elif transaction|get_transaction_model == 'ExceptionnalMovement' %}
            {% if transaction.is_credit %}
              {{ transaction.amount }}€
            {% else %}
              -{{ transaction.amount }}€
            {% endif %}
          {% elif transaction|get_transaction_model == 'Transfert' %}
            {% if transaction.recipient == object %}
              {{ transaction.amount }}€
            {% else %}
              -{{ transaction.amount }}€
            {% endif %}
          {% elif transaction|get_transaction_model == 'SharedEvent' %}
              -{{ transaction.amount }}€
          {% else %}
            {{ transaction.amount }}€
          {% endif %}
        </td>
        {% if group|has_group_perm:"retrieve_sale" %}
          <td><a href="
            {% if transaction|get_transaction_model == 'Sale' %}
              {% url 'url_sale_retrieve' group_name=group_name pk=transaction.pk %}
            {% elif transaction|get_transaction_model == 'Recharging' %}
              {% url 'url_recharging_retrieve' group_name=group_name pk=transaction.pk %}
            {% elif transaction|get_transaction_model == 'Transfert' %}
              {% url 'url_transfert_retrieve' group_name=group_name pk=transaction.pk %}
            {% elif transaction|get_transaction_model == 'ExceptionnalMovement' %}
              {% url 'url_exceptionnalmovement_retrieve' group_name=group_name pk=transaction.pk %}
            {% endif %}
            ">Détail</a></td>
          {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}
{% endblock %}
